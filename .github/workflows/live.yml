name: website

on:
  #push:
  #  branches:
  #    - main
  #  paths:
  #    - 'assets/md_files/**'
  #    - 'assets/blog/**'
  #    - '.github/workflows/**'
  #    - 'README.md'
  #    - 'md_to_html_parser.py'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Job 2: Generate HTML files from README.md under site/contents and styles under site/style, then publish to site/view 
  build:
    name: Build HTML files
    runs-on: ubuntu-latest
    env:
      SITE_PATH: "assets/site/content/"
      OUTPUT_PATH: "assets/site/view/"
      CSS_PATH: "assets/site/style/css/v01/"
      PY_PATH: "assets/builders/"
    if: success() #&& false # Disable this job for now
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main  # Ensure we get the latest README.md
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install markdown
          
      - name: Generate HTML files from README.md
        run: |
          echo "Generating HTML files from README.md..."

          python ${{ env.PY_PATH }}static_site_generator_2.py
          
          echo "HTML generation complete!"
      
      #- name: Install Dart Sass
      #  run: |
      #    sudo apt-get update
      #    sudo apt-get install -y wget
      #    wget https://github.com/sass/dart-sass/releases/download/1.77.5/dart-sass-1.77.5-linux-x64.tar.gz
      #    sudo tar -xvf dart-sass-1.77.5-linux-x64.tar.gz -C /usr/local/bin/
      #    sudo ln -s /usr/local/bin/dart-sass/sass /usr/local/bin/sass
      #- name: Compile SCSS to CSS (with source map)
      #  run: |
      #    echo "Compiling SCSS to CSS..."
      #    sass assets/site/style/scss/main.scss assets/site/style/css/main.css --source-map
      #    echo "CSS compilation complete!"
      
      - name: Commit generated HTML #and CSS files
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add ${{ env.OUTPUT_PATH }} # assets/site/style/css/main.css assets/site/style/css/main.css.map
          git diff --staged --quiet || git commit -m "Auto-generate HTML [skip ci]"
      
      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.OUTPUT_PATH }}
      
      - name: Build Summary
        if: always()
        run: |
          echo "### Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "${{ env.OUTPUT_PATH }}index.html" ]; then
            echo "HTML files generated successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "HTML generation failed" >> $GITHUB_STEP_SUMMARY
          fi

  # Job 3: Deploy to GitHub Pages
  deploy:
    name: Deploy to GitHub Pages
    needs: build
    if: success() #&& false # Disable this job for now
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Deployment Summary
        if: always()
        run: |
          echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Site deployed to: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY